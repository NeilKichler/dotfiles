#!/usr/bin/env bash
# Code search using bemenu (single string)
# Requires bemenu, tree, neovim, and python

readonly confdir=${XDG_CONFIG_HOME:-$HOME/.config}
readonly optsfile=$confdir/dmenu/bemenucolors
readonly terminal=/usr/bin/termite
readonly locations=( ~/programming
                     ~/piecemeal
                     ~/piecemealdb
                     ~/.config
                     ~/.local
                     ~/quartz
                     ~/stuff );

get_selection() {
    grep -Ire "$1" "${locations[@]}" | bemenu -l 10 "${opts[@]}" -p "Edit"
}

handle_result() {

    local result="$1"

    if ! pgrep nvim; then
        export NVIM_LISTEN_ADDRESS=/tmp/nvimsocket
        exec $terminal --exec="/usr/bin/nvim $result" &
    else

python - <<END
from neovim import attach
nvim = attach('socket', path='/tmp/nvimsocket')
nvim.command('e $result')
END

fi
}

# Main

# https://github.com/halfwit/dotfiles/blob/master/.config/dmenu/font
if [[ -s $confdir/dmenu/font ]]; then
    read -r font < "$confdir"/dmenu/font
fi

if [[ $font ]]; then
    opts+=(-fn "$font")
fi

if [[ -s $optsfile ]]; then
    source "$optsfile"
fi

result=$(get_selection "$1")

if [[ $result ]]; then
    handle_result "${result%:*}"
fi

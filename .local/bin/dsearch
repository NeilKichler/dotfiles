#!/usr/bin/env bash
# Dmenu search with Qutebrowser history

readonly progn=dsearch
readonly confdir=${XDG_CONFIG_HOME:-$HOME/.config}
readonly datadir=${XDG_DATA_HOME:-$HOME/.local/share}

readonly optsfile="${XDG_CONFIG_HOME:-$HOME/.config}"/dmenu/bemenucolors

has() {
    hash "$1" &> /dev/null
}

puts() {
    printf -- "$1\n" "${@:2}"
}

err() {
    local msg

    puts "$progn: $1" "${@:2}"

    if has notify-send; then
	msg="$(puts "$@")"
	notify-send -u critical -- "$progn" "$msg"
    fi
}

create_menu() {
    # Check quickmarks
    while read -r url; do
        printf -- '%s\n' "$url"
    done < "$confdir"/qutebrowser/quickmarks

    # Next bookmarks
    while read -r url _; do
        printf -- '%s\n' "$url"
    done < "$confdir"/qutebrowser/bookmarks/urls

    # Finally history
    while read -r _ url; do
        printf -- '%s\n' "$url"
    done < "$datadir"/qutebrowser/history
}

get_selection() {
    opts+=(-p Search)
    #create_menu | dmenu -l 10 "${opts[@]}"
    create_menu | bemenu -l 10 "${opts[@]}"
    #create_menu | rofi -dmenu -p "Search" -fg '#f9f5d7' -bg '#282828' -hlfg '#f9f5d7' -hlbg '#928374' -font "$font"
}

handle_results() { # args -> launch
    case "$1" in
        !yt*) "$HOME"/.local/bin/ythandler "${1:4}" ;;
        !playlist*) "$HOME"/.local/bin/playlisthandler "${1:10}" ;;
        !radio*) "$HOME"/.local/bin/gmusichandler "${1:7}" ;;
        !song*) "$HOME"/.local/bin/gsonghandler "${1:6}" ;;
        !book*) "$HOME"/.local/bin/gbookhandler "${1:6}" ;;
        !gh*) printf -- '%s' "open -t https://github.com/search?utf8=%E2%9C%93&q=${1:4}&ref=simplesearch" >> "$QUTE_FIFO" || qutebrowser "https://github.com/search?utf8=%E2%9C%93&q=${1:4}&ref=simplesearch" ;;
        !aw*) printf -- '%s' "open -t https://wiki.archlinux.org/?search=${1:4}" >> "$QUTE_FIFO" || qutebrowser https://wiki.archlinux.org/?search="${1:4}" & ;;
        !fb*) chromium https://www.facebook.com/ ;;
        !gplus*) chromium https://plus.google.com/ ;;
        !code*) "$HOME"/.local/bin/codehandler "${1:6}" ;;
        !g*) printf -- '%s' "open -t ${1:3}" >> "$QUTE_FIFO" || qutebrowser "${1:3}" & ;;
        *) printf -- '%s' "open -t $1" >> "$QUTE_FIFO" || qutebrowser "$1" & ;;
    esac
}

# Main
# https://github.com/halfwit/dotfiles/blob/master/.config/dmenu/font
if [[ -s $confdir/dmenu/font ]]; then
    read -r font < "$confdir"/dmenu/font
fi

if [[ $font ]]; then
    opts+=(-fn "$font")
fi

if [[ -s $optsfile ]]; then
    source "$optsfile"
fi

query=$(get_selection)
query=${query/*http/http}

# If no selection is made, exit (escape pressed, e.g.)
[[ ! $query ]] && exit 0

handle_results "$query"

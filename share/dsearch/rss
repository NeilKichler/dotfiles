#!/bin/bash

## Dmenu based frontend to read RSS directory
RSS=$XDG_CACHE_HOME/rss

select_site() {
    cd "$1"
    for i in *; do
        [[ "$i" != "url" ]] && printf '%s\n' "$i"
    done
}

filter_read() {
	while read -r title; do
        if ls "$RSS/$title"/\[new\]* &>/dev/null; then
            printf '%s\n' "$title"
        fi
    done
	printf '%s\n%s\n' "view all" "quit"
}

append() {
    while read -r entry; do
        printf '%s\n' "$entry"
    done
    printf '%s\n' "$1"
}

handle_result() {
    read -r selection
    if [[ $selection == "mark all as read" ]]; then
        cd "$RSS/$1"
        for i in *; do
            mv "$i" "${i/\[new\]\ /}"
        done
        exit 0 
    fi
    if [[ $selection == "quit" ]]; then
        exit 1
    fi

    read -r url < "$RSS/$1/$selection"
    mv "$RSS/$1/$selection" "$RSS/$1/${selection/\[new\]\ /}"
    plumber "$url" & 
}

feed=$(ls "$RSS" | filter_read | dmenu -p "Select sub: ")

if [[ $feed == "view all" ]]; then
    feed=$(ls -t -I url -I count "$RSS" | append "quit" | dmenu) 
fi

if [[ $feed == "quit" || ! $feed ]]; then
	ls "$RSS" | filter_read | wc -l | sed 's/$/-2/' | bc > "$RSS"/count
    exit 0
fi

ls -t -I url "$RSS/$feed" | append "mark all as read" | append "quit" |  dmenu -p "Select feed: " | handle_result "$feed" || exit 1

if [[ $(ls "$RSS" | filter_read | wc -l) == 0 ]]; then
	echo 0 > "$RSS"/count
	exit
fi

sleep .1
exec "$XDG_DATA_HOME"/dsearch/rss

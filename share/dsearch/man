#!/usr/bin/env bash

readonly optsfile="$XDG_CONFIG_HOME"/dmenu/bemenucolors

handle_result() {
   local width
   #Coloration, and match width
   width=$(tput cols)
   [[ $width -gt $MANWIDTH ]] && \
   exec env LESS=-RX \
   MANWIDTH="$width" \
   LESS_TERMCAP_mb=$'\E[01;31m' \
   LESS_TERMCAP_md=$'\E[01;38;5;74m' \
   LESS_TERMCAP_me=$'\E[0m' \
   LESS_TERMCAP_se=$'\E[0m' \
   LESS_TERMCAP_so=$'\E[38;5;246m' \
   LESS_TERMCAP_ue=$'\E[0m' \
   LESS_TERMCAP_us=$'\E[04;38;5;146m' \
   st -t float -e man "$1"
}

get_selection() {
  opts+=(-l 10 -p "Manual: ")
  apropos . | bemenu "${opts[@]}"
}

## Main ##
# Configuration
# https://github.com/halfwit/dotfiles/blob/master/.config/dmenu/font

[[ -s $optsfile ]] && source "$optsfile"

[[ $1 ]] && result="$1" || result="$(get_selection)" 

if ! grep -q "$result" <<< $(apropos .); then
  thingmenu -g  160x120 -x \
    "Posix" "exec browse '\!posix $1'" \
    "Mankier" "exec browse '\!mankier $1'" \
    "Man7" "exec browse '\!man7 $1'" \
    "Man" "exec browse '\!man $1'" 
fi

if [[ $result ]]; then
  handle_result "$result"
fi

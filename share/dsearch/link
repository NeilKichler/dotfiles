#!/usr/bin/env bash

# Database of bookmarks for quick linking
# Use namespacing in the title (dead simple, yay!!)
readonly optsfile=$XDG_CONFIG_HOME/dmenu/bemenucolors
readonly datadir="$XDG_DATA_HOME"
get_selection() {
  find "$datadir"/bookmark -type f -not -path '*/\.*'
  find "$datadir"/mpv -type f -not -path '*/\.*'
}

extract_links() {
  local url
  while read -r input; do
    case "$input" in
      *bookmark*)
        read -r url < "$input"
        printf '%s\n' "${input##*bookmark\/}"
        ;;
      *mpv*)
        input="${input/.pls/}"
        printf '%s\n' "video - ${input##*mpv\/}"
        ;;
    esac
  done
}

handle_mpv() {
  result=$(sed -n -e 's/^Title[0-9]=//p' < "$datadir/mpv/${1##*-\ }.pls" | bemenu "${opts[@]}" -p "Select title") 
  [[ ! $result ]] && exec "$datadir/dsearch/link"
  sed -n -e "/$result/ { n; s/^File[0-9]=//p }" < "$datadir/mpv/${1##*-\ }.pls"
}

[[ -s $optsfile ]] && source "$optsfile"

opts+=( -l 10 -p "Select bookmark" )
result=$(get_selection | sort -u | extract_links | bemenu "${opts[@]}" )
[[ -s $datadir/mpv/${result##*-\ }.pls ]] && result=$(handle_mpv "$result") ||  read -r result < "$datadir/bookmark/$result"
[[ $result ]] && exec xcmenu -ic "$result"

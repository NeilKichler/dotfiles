#!/usr/bin/env bash
# Write/remove a task to do later.

readonly optsfile="$XDG_CONFIG_HOME"/dmenu/bemenucolors

TASKFILE="$XDG_CACHE_HOME/todo/$1"

menu() {
  opts+=(-l 10 -p "Add new or select to toggle task" -I "$(($1 - 1))")
  bemenu "${opts[@]}" < "$TASKFILE"
}

loop_run() {
  local sub result place=1
  while true; do
    result=$(menu "$place")
    # Return to main program on exit
    [[ ! $result ]] && exec "$XDG_DATA_HOME"/dsearch/todo
    case $result in
      \(\ \)*) sub="${result/\(\ \)/(x)}"
               place=$(sed -n "/$result/{=; q;}" "$TASKFILE")
               sed -i "s:$result:$sub:g" "$TASKFILE" ;;
      \(x\)*)  sub="${result/\(x\)/( )}"
               place=$(sed -n "/$result/{=; q;}" "$TASKFILE")
               sed -i "s:$result:$sub:g" "$TASKFILE" ;;
      *) place=$(wc -l "$TASKFILE" | awk '{ print $1+1 }') 
         printf '%s\n' "( ) $result" >> "$TASKFILE" ;;
    esac
  done
}

## Main

[[ -s $optsfile ]] && source "$optsfile"

loop_run

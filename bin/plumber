#!/usr/bin/env bash

input="$1"
while read -r item; do
  input+="$item"
done

if [[ -f "$input" ]]; then
  mime=$(file -biL "$input")
  [[ $mime ]] && case $mime in
    text/html*)
      exec vimb-run "$input" ;;
    text*)
      exec nvim-run "$input" ;;
    *pdf*|*epub*|*djvu*)
      exec tzathura "$input" ;;
    image*)
      exec imv "$input"      ;;
    video*)
      exec mpv "$input"      ;;
    *)
      notify-send "Error with $input"
      exec nvim-run ~/local/bin/plumber ;;
  esac
fi

printf '%s' "$input" | xcmenu -ic

case "$input" in
    gopher://*)
      exec st -e cgo "$input"              ;;
    *.pdf|*.djvu)            
      curl -s "$input" > /tmp/tmp.book
      exec tzathura /tmp/tmp.book      ;;
    *.epub)
      curl -s "$input" > /tmp/tmp.book
      pandoc /tmp/tmp.book -o /tmp/tmp.pdf
      exec tzathura /tmp/tmp.pdf       ;;
    *youtube.com/watch*|*youtu.be*|ytdl*|*livestream.com*|*twitch*|*.mkv|*.mp4|*.webm|*.mpg|*.ogg|*.gifv)                     
      exec mpv-run "$input"                ;;
    *.jpg*|*.png|*.jpeg|*.gif)      
      curl -s "$input" | exec imv -             ;;
    *.tar*)                         
      cd /tmp || exit 0
      curl -s "$input" | tar -xvz
      exec st                          ;;
    *xkcd*)
      curl -s "https://xkcd.com/${input//[^0-9]/}/" | awk '/hotlink/{ print $NF }' | xargs curl | exec imv - ;;
    *imgur.com/gallery/*)
      exec mpv "$input"                         ;;
    http://imgur*)                        
      curl -s http://i.imgur.com/"${input: -7}".png | exec imv - ;;
    *0x0*)
      curl -I "$input" | grep Location | awk '{ print $2 }' > /tmp/tmpfile
      exec plumber /tmp/tmpfile ;;
    *ptpb.pw/t/*)
      curl -s "https://ptpb.pw/${input: -4}" > /tmp/tmpfile
      exec st -e asciinema play /tmp/tmpfile ;;
    http*)                          
      if curl -I "$input" | grep -e html -e x-empty; then
        exec vimb-run "$input" 
      else
        curl -S "$input" > /tmp/tmpfile
        exec plumber /tmp/tmpfile
      fi ;;
    *\(*)  
        exec "$XDG_DATA_HOME"/dsearch/manual "${input%\(*}"      ;;
    *)
      if grep "$input" <<< "$(apropos .)"; then
        exec "$XDG_DATA_HOME"/dsearch/manual "$input"
      else
        exec vimb-run "!g $input"
      fi ;;
esac

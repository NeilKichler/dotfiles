#!/usr/bin/env bash

shopt -s extglob

# Workaround until we have a filesystem based browser
fetch() {
  local tmp
  if [[ -f "$1" ]]; then 
    tmp="$1" 
  else tmp=$(mktemp)
    curl -s "$1" -o "$tmp"
  fi
  printf '%q\n' "$tmp"
}

# Presently redundant
handle() {
  local input
  while read -r input; do
    case "$input" in
      browse) exec browse     "$1" ;;
      play)   exec play       "$(fetch "$1")" ;;
      view)   exec imv        "$(fetch "$1")" ;;
      docs)   exec zathura    "$(fetch "$1")" ;;
      edit)   exec st -e nvim "$(fetch "$1")" ;;
      hear)   exec mpd        "$(fetch "$1")" ;;
    esac
  done
}

special() {
  case "$1" in
    *xkcd*) handle view "$(curl -s "https://xkcd.com/${1//[^0-9]/}/" | awk '/hotlink/{ print $NF }')" ;;  
    *ptpb.pw/t/*) exec st -e asciinema play <(curl -s "${1/\/t/}") ;;
    *youtube.com/watch*|*youtu.be*|ytdl*) exec play "$1" ;;
    *livestream.com*|*twitch.tv*|*imgur*) exec play "$1" ;;
    gopher://*) exec st -e cgo "$1" ;;
    *ptpb.pw/*/*) printf '%s\n' "edit" | handle "${1%/*}" ;;
  esac
} 

# In testing, this outputs a correct mime
mime() {
  if [[ -f $1 ]];then 
    file -bL --mime-type "$1"
  else
    printf '%s\n' "$1" | xcmenu -ic
    # messy, but just in case
    curl -sI "$1" | sed -n 's/content-type: *//pi' | tr -cd '\12\40\55-\71\100-\132\141-\172' | awk '{ print $1 }'
  fi
}

parse() {
  local result
  result="$(sed -n 's|'"$1"' ||pi' "$XDG_DATA_HOME/plumber/${1%\/*}")"
  [[ $result ]] && printf '%s\n' "$result" || printf '%s\n%s\n' "$1" "from parse" >> ~/mime_issues
}

special "$1"

mime "$1" | while read -r mimetype; do
  case "$mimetype" in
    appli*) parse "$mimetype" | handle "$1" ;;
    video*) parse "$mimetype" | handle "$1" ;;
    audio*) parse "$mimetype" | handle "$1" ;;
    image*) parse "$mimetype" | handle "$1" ;;
    inode*) parse "$mimetype" | handle "$1" ;;
    text*)  parse "$mimetype" | handle "$1" ;;
    *) print '%s\n%s\n' "$mimetype" "from mime" >> ~/mime_issues ;;
  esac
done

## NOTES: 
# inode is a directory spec on linux

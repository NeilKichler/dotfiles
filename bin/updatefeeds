#!/usr/bin/env bash

## Script to fetch RSS + atom feeds 
RSS="$XDG_CACHE_HOME"/rss

generate_files() {
    curl -sBX GET -L "$1" -A "Mozilla/5.0 (Linux; Android 6.0.1; Nexus  MOB3OD)" | xml2 | grep -e '/feed/entry/title' -e '/feed/entry/link.*href'
}

build_folders() {

    while {
        read -r first
        read -r second
    } do
    
    #This sucks, but whatever
    case "$first" in
        *title*) title="$(echo "$first" | sed 's|/feed/entry/title=||' | sed 's|/||g')" 
                 link="$(echo "$second" | xurls)" ;;
        *link*)  title="$(echo "$second" | sed 's|/feed/entry/title=||' | sed 's|/||g')"
                 link="$(echo "$first" | xurls)" ;;
    esac
    
    if [[ ! -f "$RSS/$1/$title" ]]; then
        echo "$link" > "$RSS/$1/[new] $title"
    fi
    
    done
}

cd "$RSS"
for i in *; do
    read -r url < "$i"/url
    generate_files "$url" | build_folders "$i"
done

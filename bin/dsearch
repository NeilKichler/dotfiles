#!/usr/bin/env bash
# Dmenu search with history

readonly datadir=$HOME/local/share
readonly handledir="$datadir"/dsearch
readonly optsfile="$XDG_CONFIG_HOME"/dmenu/bemenucolors
readonly search="https://duckduckgo.com?q="

create_menu() {
  local open  
  # Last selection
  xcmenu --list | head -n 1

  # Open browsers
  lsw -a | xargs wname | grep -a browse | while read -r open; do
    case "$open" in
      *-\ browse) 
                  printf '%s %s\n' "open - " "${open##*|\ }"  ;;
    esac
  done

  # Check bookmarks
  cd "$datadir/bookmark" || exit 1
  find -not -path '*/\.*' -type f -printf "%f\n" | sort -u

  # This is for mpv playlists
  cd "$datadir/mpv" ||  exit 1
  for file in *; do
    printf '%s\n' "playlist - ${file/.pls/}" 
  done | sort -u
  
  # Bang completions
  cd "$handledir" || exit 1
  find -type f -printf "!%f\n" | sort -u
  printf '%s\n%s\n%s\n' "!snap" "!stop" "!close"

  find ~/ -type f
}

get_selection() {
  opts+=(-p Search)
  create_menu | bemenu -l 10 "${opts[@]}"
}

handle_results() { # args -> launch
  case "$@" in
    
    !listen) exec "$handledir"/listen ;;
    !lyrics) exec "$handledir"/lyrics ;;
    !photo)  exec "$handledir"/photo  ;;
    !notes)  exec "$handledir"/notes  ;;
    !docs)   exec "$handledir"/docs   ;;
    !game)   exec "$handledir"/game   ;;
    !save)   exec "$handledir"/save   ;;
    !link)   exec "$handledir"/link   ;;
    !song)   exec "$handledir"/song   ;;
    !todo)   exec "$handledir"/todo   ;;
    !rss)    exec "$handledir"/rss    ;;
    !man)    exec "$handledir"/man    ;;
    !mix)    exec "$handledir"/mix    ;;
    !vm)     exec "$handledir"/vm     ;;
    
    playlist\ -\ *) exec "$handledir"/mpv    "${1#*-\ }.pls" ;;
    open\ -\ *)     exec "$handledir"/stack  "${1#*-\ }"     ;;
    !reddit*)       exec "$handledir"/reddit "${1#*reddit }" ;;
    !listen*)       exec "$handledir"/listen "${1#*listen }" ;;
    !lyrics*)       exec "$handledir"/lyrics "${1#*lyrics }" ;;
    !radio*)        exec "$handledir"/radio  "${1#*radio }"  ;;
    !album*)        exec "$handledir"/album  "${1#*album }"  ;;
    !quote*)        exec "$handledir"/quote  "${1#*quote }"  ;;
    !save*)         exec "$handledir"/save   "${1#*save }"   ;;
    !song*)         exec "$handledir"/song   "${1#*song }"   ;;
    !book*)         exec "$handledir"/book   "${1#*book }"   ;;
    !code*)         exec "$handledir"/code   "${1#*code }"   ;;
    !dict*)         exec "$handledir"/dict   "${1#*dict }"   ;;
    !man*)          exec "$handledir"/man    "${1#*man }"    ;;
    !mix*)          exec "$handledir"/mix    "${1#*mix }"    ;;
    !pl*)           exec "$handledir"/yt     "$1"            ;;
    !yt*)           exec "$handledir"/yt     "${1#*yt }"     ;;

    !close)  exec pkill surf                                 ;;
    # Not really search related, but useful 
    !snap)   exec "$handledir"/rec "snap"                    ;;
    !stop)   exec "$handledir"/rec "stop"                    ;;
    !rec)    exec "$handledir"/rec "vid"                     ;;
    *\ -\ *) read -r result < "$datadir/bookmark/$1" 
              exec browse "$result"     ;;   
    !*)      exec browse "$search$1"   ;;
    *)       exec browse "$1" ;;

  esac
}

# Main
[[ -s $optsfile ]] && source "$optsfile"

[[ $1 ]] && query=$1 || query=$(get_selection)
query=${query/*http/http}

# Verify selection
[[ ! $query ]] && exit 0
[[ -f $query ]] && exec plumber "$query"
handle_results "$query"

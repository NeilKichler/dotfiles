#!/usr/bin/env bash
# Dmenu search with history

readonly datadir=${XDG_DATA_HOME:-$HOME/local/share}
readonly handledir="$datadir"/dsearch
readonly confdir="$XDG_CONFIG_HOME"
readonly optsfile="$confdir"/dmenu/bemenucolors

create_menu() {
    
    # Last selection
    xcmenu --list | head -n 1

    # Check bookmarks
    while read -r url name; do
        printf -- '%s %s\n' "$name" "$url"
    done < "$confdir"/vimb/bookmark

    # This is for mpv playlists
    ( cd "$XDG_DATA_HOME/mpv" ||  exit 1
    for file in *; do
        printf '%s' "!mpv $file"
    done
    )
}

get_selection() {
    opts+=(-p Search)
    create_menu | bemenu -l 10 "${opts[@]}"
}

handle_results() { # args -> launch
    case "$@" in
        !radio*) exec "$handledir"/gmusic     "${1##*radio }" ;;
        !song*)  exec "$handledir"/gsong      "${1##*song }"  ;;
        !book*)  exec "$handledir"/gbook      "${1##*book }"  ;;
        !code*)  exec "$handledir"/code       "${1##*code }"  ;;
        !dict*)  exec "$handledir"/dictionary "${1##*dict }"  ;;
        !mpv*)   exec "$handledir"/mpv        "${1##*mpv }"   ;;
        !man)    exec "$handledir"/manual                     ;;
        !man*)   exec "$handledir"/manual     "${1##*man }"   ;;
        !pl*)    exec "$handledir"/playlist   "${1##*pl }"    ;;
        !yt*)    exec "$handledir"/yt         "${1##*yt }"    ;;
        *)       exec vimb-run                "$1"            ;;
    esac
}

# Main
[[ -s $optsfile ]] && source "$optsfile"

query=$(get_selection)
query=${query/*http/http}

# Verify selection
[[ ! $query ]] && exit 0

handle_results "$query"

#!/usr/bin/env bash
# Dmenu search with history

readonly datadir=$HOME/local/share
readonly handledir="$datadir"/dsearch
readonly optsfile="$XDG_CONFIG_HOME"/dmenu/bemenucolors

create_menu() {
  local open  
  # Last selection
  xcmenu --list | head -n 1

  # Open browsers
  lsw -a | xargs wname | grep -a browse | while read -r open; do
    case "$open" in
      *-\ browse) printf '%s %s\n' "open - " "${open##*|\ }"  ;;
    esac
  done

  # Check bookmarks
  (cd "$datadir/bookmark" || exit 1
  find -not -path '*/\.*' -type f -printf "%f\n" | sort -u)

  # This is for mpv playlists
  (cd "$datadir/mpv" ||  exit 1
  for file in *; do
    printf '%s\n' "playlist - $file" 
  done | sort -u)
  
  # Bang completions
  (cd "$handledir" || exit 1
  find -type f -printf "!%f\n" | sort -u)
  printf '%s\n%s\n%s\n' "!snap" "!stop" "!close"
}

get_selection() {
  opts+=(-p Search)
  create_menu | bemenu -l 10 "${opts[@]}"
}

handle_results() { # args -> launch
  case "$@" in
    playlist\ -\ *) exec "$handledir"/mpv   "${1#*-\ }"    ;;
    open\ -\ *)     exec "$handledir"/stack "${1#*-\ }"    ;;
    !radio*)        exec "$handledir"/radio "${1#*adio }"  ;;
    !song*)         exec "$handledir"/song  "${1#*song }"  ;;
    !book*)         exec "$handledir"/book  "${1#*book }"  ;;
    !code*)         exec "$handledir"/code  "${1#*code }"  ;;
    !dict*)         exec "$handledir"/dict  "${1#*dict }"  ;;
    !man*)          exec "$handledir"/man   "${1#*man }"   ;;
    !pl*)           exec "$handledir"/yt    "$1"           ;;
    !yt*)           exec "$handledir"/yt    "${1#*yt }"    ;;

    !photo)  exec "$handledir"/photo  ;;
    !notes)  exec "$handledir"/notes  ;;
    !docs)   exec "$handledir"/docs   ;;
    !game)   exec "$handledir"/game   ;;
    !save)   exec "$handledir"/save   ;;
    !link)   exec "$handledir"/link   ;;
    !todo)   exec "$handledir"/todo   ;;
    !man)    exec "$handledir"/man    ;;
    !vm)     exec "$handledir"/vm     ;;
  
    !close)  exec pkill surf                            ;;
    !snap)   exec "$handledir"/rec "snap"               ;;
    !stop)   exec "$handledir"/rec "stop"               ;;
    !rec)    exec "$handledir"/rec "vid"                ;;
    *\ -\ *) read -r result < "$datadir/bookmark/$1" 
             exec browse    "$result"                   ;;   
    !*)      exec browse "https://duckduckgo.com/?q=$1" ;;
    *)       exec browse "$1"

  esac
}

# Main
[[ -s $optsfile ]] && source "$optsfile"

query=$(get_selection)
query=${query/*http/http}

# Verify selection
[[ ! $query ]] && exit 0

handle_results "$query"

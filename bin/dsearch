#!/usr/bin/env bash
# Dmenu search with Qutebrowser history

readonly progn=dsearch
readonly confdir=${XDG_CONFIG_HOME:-$HOME/local/cfg}
readonly datadir=${XDG_DATA_HOME:-$HOME/local/share}

readonly optsfile="${XDG_CONFIG_HOME:-$HOME/local/cfg}"/dmenu/bemenucolors

has() {
    hash "$1" &> /dev/null
}

puts() {
    printf -- "$1\n" "${@:2}"
}

err() {
    local msg

    puts "$progn: $1" "${@:2}"

    if has notify-send; then
	msg="$(puts "$@")"
	notify-send -u critical -- "$progn" "$msg"
    fi
}

create_menu() {
    # Check bookmarks
    while read -r url name; do
        printf -- '%s %s\n' "$name" "$url"
    done < "$confdir"/vimb/bookmark

    # Finally history
    while read -r url name; do
        printf -- '%s %s\n' "$name" "$url"
    done < "$confdir"/vimb/history


    # This is for mpv playlists
    ( cd "$XDG_DATA_HOME/mpv" || err "$XDG_DATA_HOME/mpv/ not found."
    for file in *; do
        puts "!mpv $file"
    done
    )
}

get_selection() {
    opts+=(-p Search)
    #create_menu | dmenu -l 10 "${opts[@]}"
    create_menu | bemenu -l 10 "${opts[@]}"
    #create_menu | rofi -dmenu -p "Search" -fg '#f9f5d7' -bg '#282828' -hlfg '#f9f5d7' -hlbg '#928374' -font "$font"
}

handle_results() { # args -> launch
    case "$@" in
        !radio*)    exec "$XDG_DATA_HOME"/dsearch/gmusichandler     "${1##*radio }" ;;
        !save*)     exec "$XDG_DATA_HOME"/dsearch/saveplhandler     "${1:6}"        ;;
        !song*)     exec "$XDG_DATA_HOME"/dsearch/gsonghandler      "${1##*song }"  ;;
        !book*)     exec "$XDG_DATA_HOME"/dsearch/gbookhandler      "${1##*book }"  ;;
        !code*)     exec "$XDG_DATA_HOME"/dsearch/codehandler       "${1##*code }"  ;;
        !pls*)      exec "$XDG_DATA_HOME"/dsearch/savesearchhandler "${1##*pls }"   ;;
        !mpv*)      exec "$XDG_DATA_HOME"/dsearch/mpvhandler        "${1##*mpv }"   ;;
        !pl*)       exec "$XDG_DATA_HOME"/dsearch/playlisthandler   "${1##*pl }"    ;;
        !yt*)       exec "$XDG_DATA_HOME"/dsearch/ythandler         "${1##*yt }"    ;;
        *)          exec "$HOME"/local/bin/vimb-run                 "$1"            ;;
    esac
}

# Main
# https://github.com/halfwit/dotfiles/blob/master/.config/dmenu/font
if [[ -s $confdir/dmenu/font ]]; then
    read -r font < "$confdir"/dmenu/font
fi

if [[ $font ]]; then
    opts+=(-fn "$font")
fi

if [[ -s $optsfile ]]; then
    source "$optsfile"
fi

query=$(get_selection)
query=${query/*http/http}

# If no selection is made, exit (escape pressed, e.g.)
[[ ! $query ]] && exit 0

handle_results "$query"

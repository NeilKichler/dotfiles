#!/usr/bin/env bash
# Dmenu search with history

readonly datadir=$HOME/local/share
readonly handledir="$datadir"/dsearch
readonly optsfile="$XDG_CONFIG_HOME"/dmenu/bemenucolors

create_menu() {
    
  # Last selection
  xcmenu --list | head -n 1

  # Check bookmarks
  ( cd "$datadir/bookmark"
  find -type f -printf "%f\n" | sort -u 
  )

  # This is for mpv playlists
  ( cd "$datadir/mpv" ||  exit 1
  for file in *; do
    printf '%s\n' "playlist - $file" | sort -u 
  done
  )
}

get_selection() {
  opts+=(-p Search)
  create_menu | bemenu -l 10 "${opts[@]}"
}

handle_results() { # args -> launch
  case "$@" in
    playlist\ -\ *)
             exec "$handledir"/mpv "${1##*-\ }"  ;;
    *\ -\ *) read -r result < "$datadir/bookmark/$1" 
             exec vimb-run  "$result" ;;   
    !photo)  exec "$handledir"/photo  ;;
    !save)   exec "$handledir"/save   ;;
    !link)   exec "$handledir"/link   ;;
    !man)    exec "$handledir"/manual ;;

    !radio*) exec "$handledir"/gmusic     "${1##*radio }" ;;
    !song*)  exec "$handledir"/gsong      "${1##*song }"  ;;
    !book*)  exec "$handledir"/gbook      "${1##*book }"  ;;
    !code*)  exec "$handledir"/code       "${1##*code }"  ;;
    !dict*)  exec "$handledir"/dictionary "${1##*dict }"  ;;
    !man*)   exec "$handledir"/manual     "${1##*man }"   ;;
    !pl*)    exec "$handledir"/playlist   "${1##*pl }"    ;;
    !yt*)    exec "$handledir"/yt         "${1##*yt }"    ;;
    *)       exec vimb-run                "$1"            ;;
  esac
}

# Main
[[ -s $optsfile ]] && source "$optsfile"

query=$(get_selection)
query=${query/*http/http}

# Verify selection
[[ ! $query ]] && exit 0

handle_results "$query"

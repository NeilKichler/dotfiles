#!/usr/bin/env bash
# Dmenu search with history

readonly datadir=$HOME/local/share
readonly handledir="$datadir"/dsearch
readonly optsfile="$XDG_CONFIG_HOME"/dmenu/bemenucolors
readonly search="https://duckduckgo.com?q="

create_menu() {
  local open  
  # Last selection
  xcmenu --list | head -n 1

  # Open browsers
  while read -r id; do
    watom "$id" WM_NAME
  done < <(lsgrp 2)

  # Check bookmarks
  cd "$datadir/bookmark" || exit 1
  find -not -path '*/\.*' -type f -printf "%f\n" | sort -u

  # This is for mpv playlists
  cd "$datadir/mpv" ||  exit 1
  for file in *.pls; do
    printf '%s\n' "playlist - ${file/.pls/}" 
  done | sort -u
  
  # Bang completions
  cd "$handledir" || exit 1
  find -type f -printf "!%f\n" | sort -u
  printf '%s\n%s\n%s\n%s\n' "!snap" "!stop" "!close" "!win"

  find ~/ -type f ! -name *.git*
}

get_selection() {
  opts+=(-p Search)
  create_menu | bemenu -l 10 "${opts[@]}"
  #create_menu | rofi -dmenu
}

handle_results() { # args -> launch
  case "$@" in
    !metal) exec browse "$search!metal%20$(mpc current | sed 's/ -.*//')" ;; 
    !listen) exec "$handledir"/listen ;;
    !lyrics) exec "$handledir"/lyrics ;;
    !pocket) exec "$handledir"/pocket ;;
	!commit) exec "$handledir"/commit ;;
    !notes)  exec "$handledir"/notes  ;;
    !photo)  exec "$handledir"/photo  ;;
    !mpvl)   exec "$handledir"/mpvl   ;;
    !read)   exec "$handledir"/read   ;;
    !docs)   exec "$handledir"/docs   ;;
    !game)   exec "$handledir"/game   ;;
    !save)   exec "$handledir"/save   ;;
    !link)   exec "$handledir"/link   ;;
    !song)   exec "$handledir"/song   ;;
    !math)   exec "$handledir"/math   ;;
    !pass)   exec "$handledir"/pass   ;;
	!push)	 exec "$handledir"/push	  ;;
    !rss)    exec "$handledir"/rss    ;;
    !man)    exec "$handledir"/man    ;;
    !mix)    exec "$handledir"/mix    ;;
    !vm)     exec "$handledir"/vm     ;;
    !pb)     exec "$handledir"/pb     ;;
    !np)     exec "$handledir"/np     ;;
   
    playlist\ -\ *)   exec "$XDG_DATA_HOME"/mpv/select_video "${1#*-\ }.pls" ;;
    *\ -\ Chromium)   exec "$handledir"/stack  "$1"            ;;
    browse\ -\ *)     exec "$handledir"/stack  "${1#*-\ }"     ;;
    !pl\ save)        exec "$XDG_DATA_HOME"/youtube/savesearch ;;
    !reddit\ *)       exec "$handledir"/reddit "${1#*reddit }" ;;
    !listen\ *)       exec "$handledir"/listen "${1#*listen }" ;;
    !lyrics\ *)       exec "$handledir"/lyrics "${1#*lyrics }" ;;
    !radio\ *)        exec "$handledir"/radio  "${1#*radio }"  ;;
    !album\ *)        exec "$handledir"/album  "${1#*album }"  ;;
    !quote\ *)        exec "$handledir"/quote  "${1#*quote }"  ;;
    !save\ *)         exec "$handledir"/save   "${1#*save }"   ;;
    !song\ *)         exec "$handledir"/song   "${1#*song }"   ;;
    !book\ *)         exec "$handledir"/book   "${1#*book }"   ;;
    !code\ *)         exec "$handledir"/code   "${1#*code }"   ;;
    !dict\ *)         exec "$handledir"/dict   "${1#*dict }"   ;;
    !math\ *)         exec "$handledir"/math   "${1#*math }"   ;;
    !man\ *)          exec "$handledir"/man    "${1#*man }"    ;;
    !mix\ *)          exec "$handledir"/mix    "${1#*mix }"    ;;
    !pkg\ *)	      exec "$handledir"/pkg    "${1#*pkg }"    ;;
    !gh\ *)   	      exec "$handledir"/gh     "${1#*gh }"     ;;
    !pl\ *)           exec "$handledir"/yt     "$1"            ;;
    !yt\ *)           exec "$handledir"/yt     "${1#*yt }"     ;;
    !pb\ *)           exec "$handledir"/pb     "${1#*pb }"     ;;
    !rq\ *)           exec "$handledir"/rq     "${1#*rq }"     ;;
    !is\ *)     plumber "$("$handledir"/is     "${1#*is }")"   ;;
  
    !close) pkill surf; pkill firefox ;;
    
    # Not really search related, but useful 
    !snap)   exec "$handledir"/rec "snap"                    ;;
    !stop)   exec "$handledir"/rec "stop"                    ;;
    !win)    exec "$handledir"/rec "win"		     ;;
    !rec)    exec "$handledir"/rec "vid"                     ;;
    *\ -\ *) read -r result < "$datadir/bookmark/$1" 
             exec browse "$result"     ;;   
    !*)      exec browse "$search$1"   ;;
    *)       exec browse "$1" ;;

  esac
}

# Main
[[ -s $optsfile ]] && source "$optsfile"

[[ $1 ]] && query=$1 || query="$(get_selection)"
query=${query/*http/http}

# Verify selection
[[ ! $query ]] && exit 0
[[ -f $query ]] && exec plumber "$query"
handle_results "$query"

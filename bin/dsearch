#!/usr/bin/env bash
# Dmenu search with Qutebrowser history

readonly progn=dsearch
readonly confdir=${XDG_CONFIG_HOME:-$HOME/local/cfg}
readonly datadir=${XDG_DATA_HOME:-$HOME/local/share}

readonly optsfile="${XDG_CONFIG_HOME:-$HOME/local/cfg}"/dmenu/bemenucolors

has() {
    hash "$1" &> /dev/null
}

puts() {
    printf -- "$1\n" "${@:2}"
}

err() {
    local msg

    puts "$progn: $1" "${@:2}"

    if has notify-send; then
	msg="$(puts "$@")"
	notify-send -u critical -- "$progn" "$msg"
    fi
}

create_menu() {
    # Check bookmarks
    while read -r url name; do
        printf -- '%s %s\n' "$name" "$url"
    done < "$confdir"/vimb/bookmark

    # Finally history
    while read -r url name; do
        printf -- '%s %s\n' "$name" "$url"
    done < "$confdir"/vimb/history
}

get_selection() {
    opts+=(-p Search)
    #create_menu | dmenu -l 10 "${opts[@]}"
    create_menu | bemenu -l 10 "${opts[@]}"
    #create_menu | rofi -dmenu -p "Search" -fg '#f9f5d7' -bg '#282828' -hlfg '#f9f5d7' -hlbg '#928374' -font "$font"
}

vimb-run() {
    if ! pgrep vimb; then
        tabbed -c -d -p -2 >/tmp/tabbed.xid; exec vimb -e "$(</tmp/tabbed.xid)" "$1"
    else
        exec vimb-run "$1"
    fi
}

handle_results() { # args -> launch
    case "$1" in
        !yt*) exec ythandler "${1:4}" ;;
        !playlist*) exec playlisthandler "${1:10}" ;;
        !radio*) exec gmusichandler "${1:7}" ;;
        !song*) exec gsonghandler "${1:6}" ;;
        !book*) exec gbookhandler "${1:6}" ;;
        !gh*) vimb-run "https://github.com/search?utf8=%E2%9C%93&q=${1:4}&ref=simplesearch" ;;
        !aw*) vimb-run https://wiki.archlinux.org/?search="${1:4}" ;;
        !code*) exec codehandler "${1:6}" ;;
        !g*) vimb-run "https://www.google.com/search?q=${1:3}" ;;
        *) vimb-run "$1" ;;
    esac
}

# Main
# https://github.com/halfwit/dotfiles/blob/master/.config/dmenu/font
if [[ -s $confdir/dmenu/font ]]; then
    read -r font < "$confdir"/dmenu/font
fi

if [[ $font ]]; then
    opts+=(-fn "$font")
fi

if [[ -s $optsfile ]]; then
    source "$optsfile"
fi

query=$(get_selection)
query=${query/*http/http}

# If no selection is made, exit (escape pressed, e.g.)
[[ ! $query ]] && exit 0

handle_results "$query"
